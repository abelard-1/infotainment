<script>
    const API_KEY = 'AIzaSyAC3QiGhqOM2F2ZrnFq3xWUu6_1bAwOvSw';
    const CAL_ID = 'rezgarhayder@gmail.com';

    async function updateCalendar() {
        const listEl = document.getElementById('custom-calendar-list');
        
        // Beräkna tidsspann: Från NU till exakt 7 dagar framåt
        const now = new Date();
        const oneWeekForward = new Date();
        oneWeekForward.setDate(now.getDate() + 7);
        
        const timeMin = now.toISOString();
        const timeMax = oneWeekForward.toISOString();

        // Vi bygger URL:en med tydliga parametrar för 7 dagar
        const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CAL_ID)}/events?key=${API_KEY}&timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;

        try {
            const res = await fetch(url);
            const data = await res.json();

            if (data.error) {
                console.error("Google API Fel:", data.error);
                listEl.innerHTML = `<div style="color:#ff6b6b; font-size:0.9rem">API-fel: ${data.error.message}<br>Kolla att kalendern är Offentlig.</div>`;
                return;
            }

            if (!data.items || data.items.length === 0) {
                listEl.innerHTML = "<div style='color:var(--text-dim)'>Inga händelser inbokade de närmaste 7 dagarna.</div>";
                return;
            }

            listEl.innerHTML = data.items.map(event => {
                const start = new Date(event.start.dateTime || event.start.date);
                
                // Formatera datum snyggt
                const dayName = start.toLocaleDateString('sv-SE', { weekday: 'short' });
                const dayNum = start.getDate();
                const month = start.toLocaleDateString('sv-SE', { month: 'short' });
                const time = event.start.dateTime ? start.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' }) : "Heldag";
                
                return `
                    <div class="event-item" style="margin-bottom: 18px; border-left: 3px solid var(--accent); padding-left: 15px;">
                        <div class="event-date" style="font-size: 0.75rem; color: var(--accent); text-transform: uppercase;">
                            ${dayName} ${dayNum} ${month} • ${time}
                        </div>
                        <div class="event-title" style="font-size: 1.15rem; font-weight: 600; margin-top: 2px;">
                            ${event.summary}
                        </div>
                    </div>
                `;
            }).join('');
        } catch (e) {
            listEl.innerHTML = "Kunde inte ansluta till kalendern.";
        }
    }

    // --- RESTEN AV FUNKTIONERNA (Väder, Klocka, Nyheter) ---
    function getWeatherIcon(code) {
        if (code <= 1) return 'sun';
        if (code <= 3) return 'cloud-sun';
        if (code <= 48) return 'cloud';
        if (code <= 67) return 'cloud-rain';
        return 'snowflake';
    }

    async function updateWeather() {
        try {
            const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=55.64&longitude=13.21&daily=weathercode,temperature_2m_max,temperature_2m_min&hourly=temperature_2m,weathercode&timezone=auto');
            const data = await res.json();
            const currH = new Date().getHours();

            let hHtml = '';
            for(let i=currH; i<currH+5; i++){
                hHtml += `<div style="text-align:center"><span style="font-size:0.8rem;color:var(--text-dim)">${i%24}:00</span><br><i data-lucide="${getWeatherIcon(data.hourly.weathercode[i])}" style="width:20px;color:var(--accent);margin:5px 0"></i><br><b>${Math.round(data.hourly.temperature_2m[i])}°</b></div>`;
            }
            document.getElementById('hourly-list').innerHTML = hHtml;

            let dHtml = '';
            for(let i=0; i<7; i++){
                const d = new Date(data.daily.time[i]).toLocaleDateString('sv-SE', {weekday:'short'});
                dHtml += `<div class="weather-row" style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05)">
                    <span style="text-transform:capitalize; width:70px">${i===0?'Idag':d}</span>
                    <i data-lucide="${getWeatherIcon(data.daily.weathercode[i])}" style="width:20px;color:var(--accent)"></i>
                    <span style="width:80px; text-align:right"><b>${Math.round(data.daily.temperature_2m_max[i])}°</b></span>
                </div>`;
            }
            document.getElementById('daily-list').innerHTML = dHtml;
            lucide.createIcons();
        } catch(e) {}
    }

    function updateClock() {
        const now = new Date();
        document.getElementById('big-time').innerText = now.toLocaleTimeString('sv-SE', {hour:'2-digit', minute:'2-digit'});
        document.getElementById('big-date').innerText = now.toLocaleDateString('sv-SE', {weekday:'long', day:'numeric', month:'long'});
    }

    const quotes = [{text:"Det vi tänker, blir vi.", author:"Buddha"}, {text:"Allt du kan föreställa dig är verkligt.", author:"Picasso"}];
    function updateQuote() { 
        const q = quotes[Math.floor(Math.random()*quotes.length)];
        document.getElementById('quote-text').innerText = `"${q.text}"`; 
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateClock(); setInterval(updateClock, 1000);
        updateWeather(); setInterval(updateWeather, 1800000);
        updateCalendar(); setInterval(updateCalendar, 300000); // 5 min
        updateQuote();
    });

    let news = []; let idx = 0;
    async function getNews() {
        const r = await fetch('https://api.rss2json.com/v1/api.json?rss_url=https://www.svt.se/nyheter/rss.xml');
        const d = await r.json(); news = d.items; rotate();
    }
    function rotate() {
        const c = document.getElementById('news-content'); const p = document.getElementById('news-progress');
        if(news[idx]) c.innerText = news[idx].title;
        p.style.transition = 'none'; p.style.width = '0%';
        p.offsetHeight; p.style.transition = 'width 10000ms linear'; p.style.width = '100%';
        idx = (idx + 1) % news.length;
        setTimeout(rotate, 10000);
    }
    getNews();
</script>
